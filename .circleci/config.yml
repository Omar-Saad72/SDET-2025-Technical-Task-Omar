# A CircleCI configuration file to run UI and API tests in separate jobs.
# The API tests will only run after the UI tests have successfully completed.

version: 2.1

jobs:
  run_ui_tests:
    docker:
      - image: cimg/node:lts-browsers
    steps:
      - checkout

      # Run UI tests for achme-chemicals
      - run:
          name: "Setup and run UI tests for achme-chemicals"
          command: |
            cd task1-achme-chemicals
            npm -y init
            npm install nightwatch
            npx nightwatch || true

      # Run UI tests for linkedin
      - run:
          name: "Setup and run UI tests for linkedin"
          command: |
            cd task2-linkedin
            npm -y init
            npm install nightwatch
            npx nightwatch || true

      # Run UI tests for my-site
      - run:
          name: "Setup and run UI tests for my-site"
          command: |
            cd task3-my-store
            npm -y init
            npm install nightwatch
            npx nightwatch || true

  run_api_tests:
    docker:
      - image: cimg/node:lts
    steps:
      - checkout

      # Run API tests for mock-user-auth
      - run:
          name: "Setup API tests for mock-user-auth"
          command: |
            cd task4-mock-user-auth/
            npm -y init
            npm install supertest mock-user-auth
            npm pkg set scripts.dev="nodemon ./node_modules/mock-user-auth/bin/www.js"
            npm run dev &
            echo $! > server.pid   # save the background process ID

      - run:
          name: "Run API Tests"
          command: |
            cd task4-mock-user-auth/
            sleep 5 # give API a moment to start
            npx nighwatch || true

      - run:
          name: "Stop API server"
          command: |
            kill $(cat task4-mock-user-auth/server.pid)

workflows:
  build_and_test:
    jobs:
      - run_ui_tests
      - run_api_tests:
          requires:
            - run_ui_tests
